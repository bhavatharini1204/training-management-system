<!DOCTYPE html>
<html>
<head>
    <title>TMS Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="sidebar">
    <h2>TMS</h2>
    <p id="welcome"></p>
    <p id="roleInfo"></p>
    <button onclick="logout()">Logout</button>
</div>

<div class="main">

    <!-- ADMIN STATS -->
    <div id="adminStats" class="card-box" style="display:none;">
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div class="card-box" style="flex:1; text-align:center;">
                <h2 id="totalUsers">0</h2>
                <p>Total Users</p>
            </div>
            <div class="card-box" style="flex:1; text-align:center;">
                <h2 id="totalCourses">0</h2>
                <p>Total Courses</p>
            </div>
            <div class="card-box" style="flex:1; text-align:center;">
                <h2 id="totalEnrollments">0</h2>
                <p>Total Enrollments</p>
            </div>
        </div>
        <canvas id="statsChart"></canvas>
    </div>

    <!-- TRAINER ADD COURSE -->
    <div id="trainerAddCourseSection" class="card-box" style="display:none;">
        <h3>Add Course</h3>
        <input type="text" id="courseName" placeholder="Course Name">
        <textarea id="courseDesc" placeholder="Course Description"></textarea>
        <button onclick="addCourse()">Add Course</button>
        <p id="courseMessage"></p>
    </div>

    <!-- AVAILABLE COURSES -->
    <div class="card-box">
        <h3>Available Courses</h3>
        <div id="courseList"></div>
    </div>

    <!-- ADMIN ENROLLMENTS -->
    <div id="adminEnrollmentsSection" class="card-box" style="display:none;">
        <h3>Student Enrollments</h3>
        <div id="adminEnrollments"></div>
    </div>

    <!-- TRAINER COURSES -->
    <div id="trainerSection" class="card-box" style="display:none;">
        <h3>My Assigned Courses</h3>
        <div id="trainerCourses"></div>
    </div>

    <!-- TRAINER STUDENTS -->
    <div id="trainerStudentsSection" class="card-box" style="display:none;">
        <h3>Students Enrolled In My Courses</h3>
        <div id="trainerStudents"></div>
    </div>

    <!-- STUDENT COURSES -->
    <div id="myCoursesSection" class="card-box" style="display:none;">
        <h3>My Enrolled Courses</h3>
        <div id="myCourses"></div>
    </div>

</div>

<script>

const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
    window.location.href = "/";
}

// Welcome text
document.getElementById("welcome").innerText = "Welcome " + user.name;
document.getElementById("roleInfo").innerText = "Role: " + user.role;

/* ===============================
   HIDE ALL SECTIONS FIRST
================================ */
document.getElementById("adminStats").style.display = "none";
document.getElementById("adminEnrollmentsSection").style.display = "none";
document.getElementById("trainerAddCourseSection").style.display = "none";
document.getElementById("trainerSection").style.display = "none";
document.getElementById("trainerStudentsSection").style.display = "none";
document.getElementById("myCoursesSection").style.display = "none";

function loadAdminStats() {

    fetch("/admin/stats")
    .then(res => res.json())
    .then(data => {

        document.getElementById("totalUsers").innerText = data.totalUsers;
        document.getElementById("totalCourses").innerText = data.totalCourses;
        document.getElementById("totalEnrollments").innerText = data.totalEnrollments;

        const ctx = document.getElementById("statsChart").getContext("2d");

        if (window.myChart) {
            window.myChart.destroy();
        }

        window.myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Users", "Courses", "Enrollments"],
                datasets: [{
                    label: "System Overview",
                    data: [
                        data.totalUsers,
                        data.totalCourses,
                        data.totalEnrollments
                    ],
                    backgroundColor: ["#2563eb", "#1e3a8a", "#60a5fa"]
                }]
            }
        });

    });
}

function loadAdminEnrollments() {

    fetch("/admin/enrollments")
    .then(res => res.json())
    .then(data => {

        const container = document.getElementById("adminEnrollments");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>No enrollments yet</p>";
            return;
        }

        data.forEach(item => {

            const div = document.createElement("div");
            div.className = "course-card";

            div.innerHTML = `
                <strong>Student:</strong> ${item.student_name}<br>
                <strong>Email:</strong> ${item.email}<br>
                <strong>Course:</strong> ${item.course_name}
            `;

            container.appendChild(div);
        });

    });
}

/* ===============================
   ROLE VISIBILITY
================================ */

if (user.role === "admin") {
    document.getElementById("adminStats").style.display = "block";
    document.getElementById("adminEnrollmentsSection").style.display = "block";
    loadAdminStats();
    loadAdminEnrollments();
}

if (user.role === "trainer") {
    document.getElementById("trainerAddCourseSection").style.display = "block";
    document.getElementById("trainerSection").style.display = "block";
    document.getElementById("trainerStudentsSection").style.display = "block";
    loadTrainerCourses();
    loadTrainerStudents();
}

if (user.role === "user") {
    document.getElementById("myCoursesSection").style.display = "block";
    loadMyCourses();
}

/* ===============================
   LOAD AVAILABLE COURSES FOR ALL
================================ */
loadCourses();

/* ===============================
   STUDENT - MY COURSES
================================ */
function loadCourses() {

    fetch("/courses")
    .then(res => res.json())
    .then(data => {

        const courseList = document.getElementById("courseList");
        courseList.innerHTML = "";

        if (data.length === 0) {
            courseList.innerHTML = "<p>No courses available</p>";
            return;
        }

        data.forEach(course => {

            const div = document.createElement("div");
            div.className = "course-card";

            div.innerHTML = `
                <strong>${course.course_name}</strong>
                <p>${course.description}</p>
                ${user.role === "user" ? 
                    `<button onclick="enroll(${course.id})">Enroll</button>` 
                    : ""}
            `;

            courseList.appendChild(div);
        });

    });
}
function enroll(courseId) {

    fetch("/enroll", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: user.id,
            course_id: courseId
        })
    })
    .then(res => res.text())
    .then(message => {
        alert(message);
        loadMyCourses();
    });
}
function loadMyCourses() {

    fetch("/my-courses/" + user.id)
    .then(res => res.json())
    .then(data => {

        const container = document.getElementById("myCourses");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>You have not enrolled in any course.</p>";
            return;
        }

        data.forEach(course => {

            const div = document.createElement("div");
            div.className = "course-card";

            const progressValue = course.progress || 0;

            div.innerHTML = `
                <strong>${course.course_name}</strong>
                <p>${course.description}</p>
                <strong>Progress:</strong> ${progressValue}%
                <div style="background:#e5e7eb; height:10px; border-radius:5px; margin-top:5px;">
                    <div style="
                        width:${progressValue}%;
                        background:#2563eb;
                        height:10px;
                        border-radius:5px;">
                    </div>
                </div>
            `;

            container.appendChild(div);
        });

    })
    .catch(err => console.log(err));
}

/* ===============================
   TRAINER - STUDENTS
================================ */
function loadTrainerStudents() {

    fetch("/trainer-students/" + user.id)
    .then(res => res.json())
    .then(data => {

        const container = document.getElementById("trainerStudents");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>No students enrolled yet</p>";
            return;
        }

        data.forEach(item => {

            const div = document.createElement("div");
            div.className = "course-card";

            const progressValue = item.progress || 0;

            div.innerHTML = `
                <strong>Student:</strong> ${item.student_name}<br>
                <strong>Email:</strong> ${item.email}<br>
                <strong>Course:</strong> ${item.course_name}<br>
                <strong>Progress:</strong> ${progressValue}%<br><br>

                <input type="number"
                       id="progress-${item.user_id}-${item.course_id}"
                       min="0" max="100"
                       value="${progressValue}"
                       style="width:80px; padding:5px;">

                <button onclick="updateProgress(${item.user_id}, ${item.course_id})">
                    Update
                </button>
            `;

            container.appendChild(div);
        });

    })
    .catch(err => console.log(err));
}
function loadTrainerCourses() {

    fetch("/trainer-courses/" + user.id)
    .then(res => res.json())
    .then(data => {

        const container = document.getElementById("trainerCourses");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>No courses assigned</p>";
            return;
        }

        data.forEach(course => {

            const div = document.createElement("div");
            div.className = "course-card";

            div.innerHTML = `
                <strong>${course.course_name}</strong>
                <p>${course.description}</p>
            `;

            container.appendChild(div);
        });

    });
}

function updateProgress(user_id, course_id) {

    const input = document.getElementById(`progress-${user_id}-${course_id}`);
    const newProgress = parseInt(input.value) || 0;

    fetch("/update-progress", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: user_id,
            course_id: course_id,
            progress: newProgress
        })
    })
    .then(res => res.text())
    .then(message => {
        alert(message);
        loadTrainerStudents();
    });
}
function addCourse() {

    const name = document.getElementById("courseName").value;
    const desc = document.getElementById("courseDesc").value;

    if (!name || !desc) {
        alert("Please fill all fields");
        return;
    }

    fetch("/add-course", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            course_name: name,
            description: desc,
            trainer_id: user.id
        })
    })
    .then(res => res.text())
    .then(message => {
        alert(message);
        document.getElementById("courseName").value = "";
        document.getElementById("courseDesc").value = "";
        loadTrainerCourses();
        loadCourses();
    });
}

/* ===============================
   LOGOUT
================================ */

function logout() {
    localStorage.removeItem("user");
    window.location.href = "login.html";
}

</script>
</body>
</html>